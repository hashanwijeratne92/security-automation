name: Trivy Image Scan
on:
  workflow_dispatch:
    inputs:
      images:
        description: 'JSON array of images'
        required: true
        type: string
      callback:
        description: 'n8n webhook URL (will receive scan results)'
        required: true
        type: string
      token:
        description: 'shared secret (echoed as X-Scanner-Token)'
        required: false
        type: string
      corr:
        description: 'correlation id (optional)'
        required: false
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.3

      # --- Login steps remain unchanged ---

      - name: Scan images (Trivy)
        id: scan
        env:
          IMAGES: ${{ github.event.inputs.images }}
        run: |
          # The IMAGES variable contains JSON, so we handle it carefully.
          # We initialize the final result JSON.
          results='{"results":[],"corr":"${{ github.event.inputs.corr }}"}'
          tmp=$(mktemp)
          
          # CRITICAL FIX 1: Use process substitution (< <(...)) to avoid subshell issues 
          # so the 'results' variable retains its value outside the loop.
          while read -r img; do
            I=$(echo "$img" | tr -d '"')
            echo "Scanning $I..."
            
            # Trivy returns exit 1 when vulns are found; we still want JSON
            trivy image --format json --severity HIGH,CRITICAL "$I" > "$tmp" || true

            # Process Trivy JSON with jq
            jq --arg image "$I" '
              {
                image: $image,
                ok: true,
                highCritCount: ([.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length),
                fixableCount: ([.Results[].Vulnerabilities[]? | select((.Severity=="HIGH" or .Severity=="CRITICAL") and (.FixedVersion != null and .FixedVersion != ""))] | length),
                rows: ([.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL") | {
                  id: .VulnerabilityID, pkg: .PkgName, installed: .InstalledVersion,
                  fixed: (.FixedVersion // ""), severity: .Severity, title: (.Title // ""),
                  url: (.PrimaryURL // ( .References[0] // "" ))
                }]),
                raw: .
              }
            ' "$tmp" > "$tmp.out"

            # Aggregate the results
            results=$(jq --slurpfile r "$tmp.out" '.results += $r' <<< "$results")
          done < <(echo "$IMAGES" | jq -c '.[]')
          
          # Save the final JSON to an easily readable artifact for the next step
          echo "$results" > final_payload.json

      # --- EASY METHOD START ---

      - name: Set Payload Output (Easy Method) ðŸ’¡
        id: set_output
        uses: actions/github-script@v7
        with:
          # Use fs.readFileSync to read the entire JSON file content
          # The core.setOutput function handles multi-line/complex strings automatically
          script: |
            const fs = require('fs');
            const payload = fs.readFileSync('final_payload.json', 'utf8');
            core.setOutput('payload', payload);

      # --- EASY METHOD END ---

      - name: POST results to n8n Webhook
        env:
          CB: ${{ github.event.inputs.callback }}
          TOK: ${{ github.event.inputs.token }}
          # Reference the output from the new step (id: set_output)
          PAYLOAD: ${{ steps.set_output.outputs.payload }}
        run: |
          hdr=(-H 'Content-Type: application/json')
          if [ -n "$TOK" ]; then
            hdr+=(-H "X-Scanner-Token: $TOK")
          fi
          # Use --data-raw for robust JSON transfer
          curl -sS -X POST "${hdr[@]}" --data-raw "$PAYLOAD" "$CB"
