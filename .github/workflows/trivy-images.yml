name: Trivy Image Scan
on:
  workflow_dispatch:
    inputs:
      images:
        description: 'JSON array of images'
        required: true
        type: string
      callback:
        description: 'n8n webhook URL (will receive scan results)'
        required: true
        type: string
      token:
        description: 'shared secret (echoed as X-Scanner-Token)'
        required: false
        type: string
      corr:
        description: 'correlation id (optional)'
        required: false
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.3

      # ===== OPTIONAL: login to private registries (uncomment the one you need) =====
      # ... (Login steps remain unchanged) ...

      - name: Scan images (Trivy)
        id: scan
        env:
          IMAGES: ${{ github.event.inputs.images }}
        run: |
          # Removed 'set -e' for more stable pipeline execution.
          
          # 1. Initialize results variable
          results='{"results":[],"corr":"${{ github.event.inputs.corr }}"}'
          tmp=$(mktemp)
          
          # 2. CRITICAL FIX: Use process substitution (< <(...)) 
          # to ensure the 'results' variable is modified in the main shell context.
          while read -r img; do
            I=$(echo "$img" | tr -d '"')
            echo "Scanning $I..."
            
            # Trivy returns exit 1 when vulns are found; we still want JSON
            trivy image --format json --severity HIGH,CRITICAL "$I" > "$tmp" || true

            jq --arg image "$I" '
              {
                image: $image,
                ok: true,
                highCritCount: ([.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length),
                fixableCount: ([.Results[].Vulnerabilities[]? | select((.Severity=="HIGH" or .Severity=="CRITICAL") and (.FixedVersion != null and .FixedVersion != ""))] | length),
                rows: ([.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL") | {
                  id: .VulnerabilityID, pkg: .PkgName, installed: .InstalledVersion,
                  fixed: (.FixedVersion // ""), severity: .Severity, title: (.Title // ""),
                  url: (.PrimaryURL // ( .References[0] // "" ))
                }]),
                raw: .
              }
            ' "$tmp" > "$tmp.out"

            results=$(jq --slurpfile r "$tmp.out" '.results += $r' <<< "$results")
          done < <(echo "$IMAGES" | jq -c '.[]') # <--- FIX APPLIED HERE
          
          echo "payload=$results" >> $GITHUB_OUTPUT

      - name: POST results to n8n Webhook
        env:
          CB: ${{ github.event.inputs.callback }}
          TOK: ${{ github.event.inputs.token }}
          PAYLOAD: ${{ steps.scan.outputs.payload }}
        run: |
          hdr=(-H 'Content-Type: application/json')
          if [ -n "$TOK" ]; then
            hdr+=(-H "X-Scanner-Token: $TOK")
          fi
          # IMPROVEMENT: Use the --data-raw option to better handle complex JSON content.
          curl -sS -X POST "${hdr[@]}" --data-raw "$PAYLOAD" "$CB"
